@page "/quiz"
@using SpanishWordLearner.Models
@using SpanishWordLearner.Services
@inject WordService WordService
@inject ProgressService ProgressService
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Spanish Quiz</PageTitle>

<div>

@if (!_quizStarted)
{
    <div class="d-flex flex-column align-center">
        <MudText Typo="Typo.h4" Class="mb-6" Style="font-weight: 600;">Start a Quiz</MudText>

        <MudPaper Elevation="0" Class="pa-6 rounded-lg" Style="border: 1px solid #E2E8F0; width: 100%; max-width: 400px;">
            <MudSelect T="int" Label="Number of questions" @bind-Value="_questionCount" Variant="Variant.Outlined" Class="mb-4">
                <MudSelectItem Value="5">5 questions</MudSelectItem>
                <MudSelectItem Value="10">10 questions</MudSelectItem>
                <MudSelectItem Value="20">20 questions</MudSelectItem>
                <MudSelectItem Value="50">50 questions</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" Label="Quiz type" @bind-Value="_quizType" Variant="Variant.Outlined" Class="mb-6">
                <MudSelectItem Value="@("SpanishToEnglish")">Spanish to English</MudSelectItem>
                <MudSelectItem Value="@("EnglishToSpanish")">English to Spanish</MudSelectItem>
                <MudSelectItem Value="@("Mixed")">Mixed</MudSelectItem>
            </MudSelect>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                       OnClick="StartQuiz" StartIcon="@Icons.Material.Rounded.PlayArrow">
                Start Quiz
            </MudButton>
        </MudPaper>
    </div>
}
else if (_quizComplete)
{
    <div class="d-flex flex-column align-center">
        <MudPaper Elevation="0" Class="pa-8 rounded-lg text-center mb-6"
                  Style="border: 1px solid #E2E8F0; width: 100%; max-width: 500px;">

            <MudIcon Icon="@(_accuracy >= 70 ? Icons.Material.Rounded.EmojiEvents : Icons.Material.Rounded.School)"
                     Size="Size.Large" Color="@(_accuracy >= 70 ? Color.Warning : Color.Primary)" Class="mb-4" />

            <MudText Typo="Typo.h4" Class="mb-2">Quiz Complete!</MudText>

            <MudText Typo="Typo.h2" Color="@GetAccuracyColor()" Class="my-4" Style="font-weight: 700;">
                @_correctAnswers / @_questions.Count
            </MudText>

            <MudText Typo="Typo.h6" Color="@GetAccuracyColor()" Class="mb-2">
                @GetAccuracyMessage()
            </MudText>

            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
                Accuracy: @_accuracy.ToString("F0")%
            </MudText>

            <div class="d-flex gap-3 justify-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartQuiz">
                    Try Again
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ResetQuiz">
                    New Settings
                </MudButton>
            </div>
        </MudPaper>

        <MudExpansionPanels Elevation="0" Style="width: 100%; max-width: 600px; border: 1px solid #E2E8F0;" Class="rounded-lg">
            <MudExpansionPanel Text="Review Answers" Style="font-weight: 500;">
                <MudSimpleTable Dense="true" Hover="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Your Answer</th>
                            <th>Correct</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in _results)
                        {
                            <tr>
                                <td>@result.Question</td>
                                <td>@result.UserAnswer</td>
                                <td>@result.CorrectAnswer</td>
                                <td>
                                    <MudIcon Icon="@(result.IsCorrect ? Icons.Material.Rounded.Check : Icons.Material.Rounded.Close)"
                                             Color="@(result.IsCorrect ? Color.Success : Color.Error)" Size="Size.Small" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </div>
}
else
{
    <div class="d-flex flex-column align-center">
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
            Question @(_currentQuestionIndex + 1) of @_questions.Count
        </MudText>

        <MudProgressLinear Color="Color.Primary" Rounded="true" Value="@((_currentQuestionIndex + 1) * 100.0 / _questions.Count)"
                           Class="mb-6" Style="width: 100%; max-width: 500px;" />

        <MudPaper Elevation="0" Class="pa-6 rounded-lg" Style="border: 1px solid #E2E8F0; width: 100%; max-width: 500px;">

            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-6">
                @if (_currentQuestion!.IsSpanishToEnglish)
                {
                    <span>What does "<strong style="color: #4F46E5;">@_currentQuestion.Word.Spanish</strong>" mean?</span>
                }
                else
                {
                    <span>How do you say "<strong style="color: #4F46E5;">@_currentQuestion.Word.English</strong>" in Spanish?</span>
                }
            </MudText>

            <div class="d-flex flex-column gap-3">
                @for (int i = 0; i < _currentQuestion.Options.Count; i++)
                {
                    var option = _currentQuestion.Options[i];
                    var optionNumber = i + 1;
                    var optionText = _currentQuestion.IsSpanishToEnglish ? option.English : option.Spanish;
                    <MudButton Variant="@GetOptionVariant(option)"
                               Color="@GetOptionColor(option)"
                               FullWidth="true"
                               Size="Size.Large"
                               OnClick="@(() => SelectAnswer(option))"
                               Disabled="@_answerSelected"
                               Class="justify-start text-left">
                        <span class="d-flex align-center gap-3" style="width: 100%;">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default"
                                     Style="min-width: 28px;" Class="px-2">@optionNumber</MudChip>
                            <span>@optionText</span>
                        </span>
                    </MudButton>
                }
            </div>

            @if (_answerSelected)
            {
                <MudAlert Severity="@(_lastAnswerCorrect ? Severity.Success : Severity.Error)" Class="mt-4" Dense="true">
                    @if (_lastAnswerCorrect)
                    {
                        <div>
                            <strong>Correct!</strong>
                            <div class="mt-2">
                                <span style="color: #4F46E5; font-weight: 600;">@_currentQuestion.Word.Spanish</span>
                                <span> = </span>
                                <span>@_currentQuestion.Word.English</span>
                                <span class="ml-2" style="opacity: 0.7;">(@_currentQuestion.Word.PartOfSpeech)</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div>
                            <strong>Incorrect</strong>
                            <div class="mt-2">
                                <span style="color: #4F46E5; font-weight: 600;">@_currentQuestion.Word.Spanish</span>
                                <span> = </span>
                                <span>@_currentQuestion.Word.English</span>
                                <span class="ml-2" style="opacity: 0.7;">(@_currentQuestion.Word.PartOfSpeech)</span>
                            </div>
                        </div>
                    }
                </MudAlert>

                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4"
                           OnClick="NextQuestion"
                           EndIcon="@Icons.Material.Rounded.ArrowForward">
                    @(_currentQuestionIndex < _questions.Count - 1 ? "Next Question" : "See Results")
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Inherit" Class="ml-2">Enter</MudChip>
                </MudButton>
            }
        </MudPaper>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-4">
            Press <strong>1-4</strong> to select, <strong>Enter</strong> or <strong>Space</strong> to continue
        </MudText>
    </div>
}
</div>

@code {
    private DotNetObjectReference<Quiz>? _dotNetRef;
    private bool _quizStarted;
    private bool _quizComplete;
    private int _questionCount = 10;
    private string _quizType = "SpanishToEnglish";

    private List<QuizQuestion> _questions = new();
    private QuizQuestion? _currentQuestion;
    private int _currentQuestionIndex;
    private bool _answerSelected;
    private SpanishWord? _selectedAnswer;
    private bool _lastAnswerCorrect;
    private int _correctAnswers;
    private double _accuracy;
    private List<QuizResult> _results = new();

    private class QuizQuestion
    {
        public required SpanishWord Word { get; set; }
        public required List<SpanishWord> Options { get; set; }
        public bool IsSpanishToEnglish { get; set; }
    }

    private class QuizResult
    {
        public required string Question { get; set; }
        public required string UserAnswer { get; set; }
        public required string CorrectAnswer { get; set; }
        public bool IsCorrect { get; set; }
    }

    private async Task StartQuiz()
    {
        _quizStarted = true;
        _quizComplete = false;
        _currentQuestionIndex = 0;
        _correctAnswers = 0;
        _results.Clear();
        _answerSelected = false;

        var allWords = WordService.GetAllWords();
        var progress = await ProgressService.GetProgressAsync();

        // Categorize words based on progress
        var newWords = new List<SpanishWord>();
        var failedWords = new List<SpanishWord>();
        var learnedWords = new List<SpanishWord>();

        foreach (var word in allWords)
        {
            if (!progress.WordStats.TryGetValue(word.Id, out var wordProgress))
            {
                // Never seen - highest priority
                newWords.Add(word);
            }
            else if (!wordProgress.IsLearned)
            {
                // Seen but not learned (failed or still learning) - can be repeated
                failedWords.Add(word);
            }
            else
            {
                // Learned - lowest priority, avoid unless necessary
                learnedWords.Add(word);
            }
        }

        // Select words prioritizing: new words first, then failed words, then learned words only if needed
        var selectedWords = new List<SpanishWord>();

        // Shuffle each category
        newWords = newWords.OrderBy(_ => Random.Shared.Next()).ToList();
        failedWords = failedWords.OrderBy(_ => Random.Shared.Next()).ToList();
        learnedWords = learnedWords.OrderBy(_ => Random.Shared.Next()).ToList();

        // Take from new words first
        var needed = _questionCount;
        selectedWords.AddRange(newWords.Take(needed));
        needed -= selectedWords.Count;

        // Then from failed words
        if (needed > 0)
        {
            selectedWords.AddRange(failedWords.Take(needed));
            needed -= failedWords.Count;
        }

        // Only use learned words if we still need more
        if (needed > 0)
        {
            selectedWords.AddRange(learnedWords.Take(needed));
        }

        // Shuffle the final selection so it's not predictable
        selectedWords = selectedWords.OrderBy(_ => Random.Shared.Next()).ToList();

        _questions = selectedWords.Select(word =>
        {
            var isSpanishToEnglish = _quizType switch
            {
                "SpanishToEnglish" => true,
                "EnglishToSpanish" => false,
                _ => Random.Shared.Next(2) == 0
            };

            var wrongOptions = allWords
                .Where(w => w.Id != word.Id)
                .OrderBy(_ => Random.Shared.Next())
                .Take(3)
                .ToList();

            var options = wrongOptions.Append(word).OrderBy(_ => Random.Shared.Next()).ToList();

            return new QuizQuestion
            {
                Word = word,
                Options = options,
                IsSpanishToEnglish = isSpanishToEnglish
            };
        }).ToList();

        _currentQuestion = _questions[0];
    }

    private void ResetQuiz()
    {
        _quizStarted = false;
        _quizComplete = false;
    }

    private async Task SelectAnswer(SpanishWord selected)
    {
        if (_answerSelected) return;

        _answerSelected = true;
        _selectedAnswer = selected;
        _lastAnswerCorrect = selected.Id == _currentQuestion!.Word.Id;

        if (_lastAnswerCorrect)
            _correctAnswers++;

        await ProgressService.RecordAnswerAsync(_currentQuestion.Word.Id, _lastAnswerCorrect);

        _results.Add(new QuizResult
        {
            Question = _currentQuestion.IsSpanishToEnglish
                ? _currentQuestion.Word.Spanish
                : _currentQuestion.Word.English,
            UserAnswer = _currentQuestion.IsSpanishToEnglish
                ? selected.English
                : selected.Spanish,
            CorrectAnswer = _currentQuestion.IsSpanishToEnglish
                ? _currentQuestion.Word.English
                : _currentQuestion.Word.Spanish,
            IsCorrect = _lastAnswerCorrect
        });
    }

    private async Task NextQuestion()
    {
        if (_currentQuestionIndex < _questions.Count - 1)
        {
            _currentQuestionIndex++;
            _currentQuestion = _questions[_currentQuestionIndex];
            _answerSelected = false;
            _selectedAnswer = null;
        }
        else
        {
            _quizComplete = true;
            _accuracy = _questions.Count > 0 ? (double)_correctAnswers / _questions.Count * 100 : 0;

            var session = new QuizSession
            {
                Date = DateTime.UtcNow,
                TotalQuestions = _questions.Count,
                CorrectAnswers = _correctAnswers,
                WordIdsTested = _questions.Select(q => q.Word.Id).ToList()
            };
            await ProgressService.RecordQuizSessionAsync(session);
        }
    }

    private Variant GetOptionVariant(SpanishWord option)
    {
        if (!_answerSelected)
            return Variant.Outlined;
        return Variant.Filled;
    }

    private Color GetOptionColor(SpanishWord option)
    {
        if (!_answerSelected)
            return Color.Default;

        if (option.Id == _currentQuestion!.Word.Id)
            return Color.Success;

        if (option.Id == _selectedAnswer?.Id)
            return Color.Error;

        return Color.Default;
    }

    private Color GetAccuracyColor() => _accuracy switch
    {
        >= 90 => Color.Success,
        >= 70 => Color.Primary,
        >= 50 => Color.Warning,
        _ => Color.Error
    };

    private string GetAccuracyMessage() => _accuracy switch
    {
        >= 90 => "Excellent work!",
        >= 70 => "Good job!",
        >= 50 => "Keep practicing!",
        _ => "Don't give up!"
    };

    [JSInvokable]
    public async Task HandleKeyDown(string key)
    {
        if (!_quizStarted || _quizComplete || _currentQuestion == null)
            return;

        // Handle answer selection with number keys
        if (!_answerSelected)
        {
            var optionIndex = key switch
            {
                "1" => 0,
                "2" => 1,
                "3" => 2,
                "4" => 3,
                _ => -1
            };

            if (optionIndex >= 0 && optionIndex < _currentQuestion.Options.Count)
            {
                await SelectAnswer(_currentQuestion.Options[optionIndex]);
                StateHasChanged();
            }
        }
        // Handle next question with Enter or Space
        else if (key == "Enter" || key == " ")
        {
            await NextQuestion();
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("quizKeyboardHandler.init", _dotNetRef);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("quizKeyboardHandler.dispose");
            _dotNetRef.Dispose();
        }
    }
}
