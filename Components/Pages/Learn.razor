@page "/learn"
@using SpanishWordLearner.Models
@using SpanishWordLearner.Services
@inject WordService WordService
@inject ProgressService ProgressService
@rendermode InteractiveServer

<PageTitle>Learn Spanish Words</PageTitle>

@if (_currentWord == null)
{
    <div class="d-flex justify-center py-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else
{
    <div class="d-flex flex-column align-center">
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
            Word @(_currentIndex + 1) of @_words.Count
        </MudText>

        <MudProgressLinear Color="Color.Primary" Rounded="true" Value="@((_currentIndex + 1) * 100.0 / _words.Count)"
                           Class="mb-6" Style="width: 100%; max-width: 400px;" />

        <MudPaper Elevation="0" Class="pa-8 rounded-xl d-flex flex-column align-center"
                  Style="border: 1px solid #E2E8F0; width: 100%; max-width: 500px; min-height: 300px;">

            <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="mb-4">
                @_currentWord.PartOfSpeech
            </MudChip>

            @if (!_showTranslation)
            {
                <MudText Typo="Typo.h2" Class="mb-6" Style="font-weight: 600; color: #5E60CE;">
                    @_currentWord.Spanish
                </MudText>

                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                           OnClick="ShowTranslation" Class="px-8">
                    Show Translation
                </MudButton>
            }
            else
            {
                <MudText Typo="Typo.h2" Class="mb-2" Style="font-weight: 600; color: #5E60CE;">
                    @_currentWord.Spanish
                </MudText>

                <MudText Typo="Typo.h5" Color="Color.Secondary" Class="mb-4">
                    @_currentWord.English
                </MudText>

                @if (!string.IsNullOrEmpty(_currentWord.ExampleSentence))
                {
                    <MudPaper Elevation="0" Class="pa-4 rounded-lg mb-4" Style="background: #F8FAFC; width: 100%;">
                        <MudText Typo="Typo.body2" Style="font-style: italic;">
                            "@_currentWord.ExampleSentence"
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @_currentWord.ExampleTranslation
                        </MudText>
                    </MudPaper>
                }

                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    Did you know this word?
                </MudText>

                <div class="d-flex gap-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Large"
                               OnClick="@(() => RecordAndNext(true))" StartIcon="@Icons.Material.Rounded.Check">
                        Yes
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Large"
                               OnClick="@(() => RecordAndNext(false))" StartIcon="@Icons.Material.Rounded.Close">
                        No
                    </MudButton>
                </div>
            }
        </MudPaper>

        <div class="d-flex gap-2 mt-4">
            <MudIconButton Icon="@Icons.Material.Rounded.ArrowBack" Variant="Variant.Outlined" Color="Color.Default"
                           OnClick="PreviousWord" Disabled="@(_currentIndex == 0)" />
            <MudIconButton Icon="@Icons.Material.Rounded.ArrowForward" Variant="Variant.Outlined" Color="Color.Default"
                           OnClick="NextWord" Disabled="@(_currentIndex >= _words.Count - 1)" />
        </div>

        <MudPaper Elevation="0" Class="pa-4 mt-6 rounded-lg" Style="border: 1px solid #E2E8F0;">
            <div class="d-flex gap-6 justify-center">
                <div class="text-center">
                    <MudText Typo="Typo.h6" Color="Color.Primary">@_sessionReviewed</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Reviewed</MudText>
                </div>
                <div class="text-center">
                    <MudText Typo="Typo.h6" Color="Color.Success">@_sessionCorrect</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Knew</MudText>
                </div>
                <div class="text-center">
                    <MudText Typo="Typo.h6" Color="Color.Info">@(_sessionAccuracy)%</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Accuracy</MudText>
                </div>
            </div>
        </MudPaper>
    </div>
}

@code {
    private List<SpanishWord> _words = new();
    private SpanishWord? _currentWord;
    private int _currentIndex;
    private bool _showTranslation;
    private int _sessionReviewed;
    private int _sessionCorrect;
    private int _sessionAccuracy => _sessionReviewed > 0 ? _sessionCorrect * 100 / _sessionReviewed : 0;

    protected override void OnInitialized()
    {
        _words = WordService.GetWordsByFrequency(200);
        if (_words.Count > 0)
        {
            _currentWord = _words[0];
        }
    }

    private void ShowTranslation()
    {
        _showTranslation = true;
    }

    private async Task RecordAndNext(bool knew)
    {
        if (_currentWord != null)
        {
            await ProgressService.RecordAnswerAsync(_currentWord.Id, knew);
            _sessionReviewed++;
            if (knew) _sessionCorrect++;
        }
        NextWord();
    }

    private void NextWord()
    {
        if (_currentIndex < _words.Count - 1)
        {
            _currentIndex++;
            _currentWord = _words[_currentIndex];
            _showTranslation = false;
        }
    }

    private void PreviousWord()
    {
        if (_currentIndex > 0)
        {
            _currentIndex--;
            _currentWord = _words[_currentIndex];
            _showTranslation = false;
        }
    }
}
