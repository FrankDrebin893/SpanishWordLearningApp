@page "/statistics"
@using SpanishWordLearner.Models
@using SpanishWordLearner.Services
@inject WordService WordService
@inject ProgressService ProgressService
@rendermode InteractiveServer

<PageTitle>Statistics</PageTitle>

<MudText Typo="Typo.h4" Class="mb-6" Style="font-weight: 600;">Your Statistics</MudText>

@if (_loading)
{
    <div class="d-flex justify-center py-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else
{
    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg text-center" Style="border: 1px solid #E2E8F0;">
                <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 600;">@_progress.TotalWordsLearned</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Learned</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg text-center" Style="border: 1px solid #E2E8F0;">
                <MudText Typo="Typo.h4" Color="Color.Info" Style="font-weight: 600;">@_progress.WordStats.Count</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Seen</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg text-center" Style="border: 1px solid #E2E8F0;">
                <MudText Typo="Typo.h4" Color="Color.Success" Style="font-weight: 600;">@_progress.TotalQuizzesTaken</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Quizzes</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg text-center" Style="border: 1px solid #E2E8F0;">
                <MudText Typo="Typo.h4" Color="Color.Warning" Style="font-weight: 600;">@(_progress.OverallAccuracy.ToString("F0"))%</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Accuracy</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg" Style="border: 1px solid #E2E8F0; height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 500;">Learning Progress</MudText>

                <div class="mb-4">
                    <div class="d-flex justify-space-between mb-1">
                        <MudText Typo="Typo.body2">Words Learned</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @_progress.TotalWordsLearned / @WordService.TotalWordCount
                        </MudText>
                    </div>
                    <MudProgressLinear Color="Color.Success" Rounded="true" Value="@(_progress.TotalWordsLearned * 100.0 / WordService.TotalWordCount)" />
                </div>

                <div>
                    <div class="d-flex justify-space-between mb-1">
                        <MudText Typo="Typo.body2">Words Seen</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @_progress.WordStats.Count / @WordService.TotalWordCount
                        </MudText>
                    </div>
                    <MudProgressLinear Color="Color.Info" Rounded="true" Value="@(_progress.WordStats.Count * 100.0 / WordService.TotalWordCount)" />
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg" Style="border: 1px solid #E2E8F0; height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 500;">Recent Quizzes</MudText>

                @if (_progress.QuizHistory.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        No quizzes taken yet. <MudLink Href="/quiz">Take a quiz!</MudLink>
                    </MudText>
                }
                else
                {
                    <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Score</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var quiz in _progress.QuizHistory.OrderByDescending(q => q.Date).Take(5))
                            {
                                <tr>
                                    <td>@quiz.Date.ToLocalTime().ToString("MMM dd")</td>
                                    <td>@quiz.CorrectAnswers / @quiz.TotalQuestions</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="@GetAccuracyChipColor(quiz.Accuracy)">
                                            @((quiz.Accuracy * 100).ToString("F0"))%
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="pa-4 rounded-lg mb-6" Style="border: 1px solid #E2E8F0;">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6" Style="font-weight: 500;">Word Performance</MudText>
            <MudToggleGroup T="string" @bind-Value="_showFilter" Color="Color.Primary" Size="Size.Small">
                <MudToggleItem Value="@("all")">All</MudToggleItem>
                <MudToggleItem Value="@("learned")">Learned</MudToggleItem>
                <MudToggleItem Value="@("struggling")">Struggling</MudToggleItem>
            </MudToggleGroup>
        </div>

        @if (_filteredWords.Count == 0)
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="py-4">
                No words to display. Start learning to see your progress!
            </MudText>
        }
        else
        {
            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                <thead>
                    <tr>
                        <th>Spanish</th>
                        <th>English</th>
                        <th>Reviews</th>
                        <th>Accuracy</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _filteredWords.Take(30))
                    {
                        <tr>
                            <td><strong style="color: #5E60CE;">@item.Word.Spanish</strong></td>
                            <td>@item.Word.English</td>
                            <td>@item.Progress.TimesReviewed</td>
                            <td>
                                <MudProgressLinear Color="@GetAccuracyProgressColor(item.Progress.Accuracy)"
                                                   Rounded="true" Value="@(item.Progress.Accuracy * 100)"
                                                   Style="min-width: 60px;" />
                            </td>
                            <td>
                                @if (item.Progress.IsLearned)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Learned</MudChip>
                                }
                                else if (item.Progress.Accuracy < 0.5 && item.Progress.TimesReviewed >= 3)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Struggling</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Learning</MudChip>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </MudPaper>

    <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="ShowResetConfirm"
               StartIcon="@Icons.Material.Rounded.DeleteForever">
        Reset All Progress
    </MudButton>

    <MudDialog @bind-Visible="_showResetConfirm">
        <TitleContent>
            <MudText Typo="Typo.h6">Reset Progress?</MudText>
        </TitleContent>
        <DialogContent>
            <MudText>Are you sure you want to reset all your progress? This cannot be undone.</MudText>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="@(() => _showResetConfirm = false)">Cancel</MudButton>
            <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="ResetProgress">Reset Everything</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    private UserProgress _progress = new();
    private bool _loading = true;
    private string _showFilter = "all";
    private List<(SpanishWord Word, WordProgress Progress)> _filteredWords = new();
    private bool _showResetConfirm;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _progress = await ProgressService.GetProgressAsync();
            UpdateFilteredWords();
            _loading = false;
            StateHasChanged();
        }
    }

    private void SetFilter(string filter)
    {
        _showFilter = filter;
        UpdateFilteredWords();
    }

    private void UpdateFilteredWords()
    {
        var allWords = WordService.GetAllWords();
        var wordProgressList = _progress.WordStats
            .Select(kvp =>
            {
                var word = allWords.FirstOrDefault(w => w.Id == kvp.Key);
                return word != null ? (Word: word, Progress: kvp.Value) : default;
            })
            .Where(x => x.Word != null)
            .ToList()!;

        _filteredWords = _showFilter switch
        {
            "learned" => wordProgressList.Where(x => x.Progress.IsLearned).ToList(),
            "struggling" => wordProgressList.Where(x => !x.Progress.IsLearned && x.Progress.Accuracy < 0.5 && x.Progress.TimesReviewed >= 3).ToList(),
            _ => wordProgressList
        };

        _filteredWords = _filteredWords.OrderByDescending(x => x.Progress.LastReviewed).ToList();
    }

    private void ShowResetConfirm() => _showResetConfirm = true;

    private async Task ResetProgress()
    {
        await ProgressService.ResetProgressAsync();
        _progress = new UserProgress();
        _filteredWords.Clear();
        _showResetConfirm = false;
    }

    private Color GetAccuracyChipColor(double accuracy) => accuracy switch
    {
        >= 0.9 => Color.Success,
        >= 0.7 => Color.Primary,
        >= 0.5 => Color.Warning,
        _ => Color.Error
    };

    private Color GetAccuracyProgressColor(double accuracy) => accuracy switch
    {
        >= 0.9 => Color.Success,
        >= 0.7 => Color.Primary,
        >= 0.5 => Color.Warning,
        _ => Color.Error
    };
}
